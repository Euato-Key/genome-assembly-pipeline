# 参数调节指南 (Parameter Tuning Guide)

本指南旨在帮助用户根据不同的物种特性、测序数据质量和服务器硬件配置，优化 `config/config.sh` 中的运行参数，以获得最佳的组装效果。

## 1. 通用资源配置

### `THREADS` (线程数)
- **默认值**: `12`
- **说明**: 指定各分析步骤（如 fastp, hifiasm, chromap 等）使用的 CPU 核心数。
- **调节建议**:
  - **服务器**: 建议设置为服务器总核心数的 70%-80%。例如 64 核服务器可设为 `48`。
  - **个人电脑**: 建议保留 2-4 个核心给系统，其余分配给 Pipeline。
  - **注意**: 线程数并非越多越好，过高的线程数在某些步骤（如 I/O 密集型任务）可能导致效率下降。

## 2. 数据质控 (Fastp)

### `FASTP_MIN_LEN` (最小读长)
- **默认值**: `145`
- **说明**: 过滤掉长度短于此值的 Reads。
- **调节建议**:
  - **Illumina WGS (150bp)**: 建议设为 `145` 或 `100`，去除因质量修剪变过短的 Reads。
  - **Hi-C (150bp)**: 同样建议设为 `100-145`。
  - **如果数据质量较差**: 可适当降低至 `50` 或 `75`，以保留更多数据，但可能会增加后续比对的错误率。

## 3. 基因组调查 (Jellyfish & GenomeScope)

### `KMER_SIZE` (K-mer 长度)
- **默认值**: `19`
- **说明**: 用于统计 K-mer 频数的长度 K。
- **调节建议**:
  - **小型基因组 (<100Mb)**: 可使用 `17` 或 `19`。
  - **中型基因组 (100Mb - 1Gb)**: 推荐 `19` 或 `21`。
  - **大型基因组 (>1Gb)**: 推荐 `21` 或 `23`。
  - **原则**: 基因组越大，K 值应越大，以避免 K-mer 碰撞；但 K 值过大也会导致覆盖度降低。

### `GENOME_SIZE_EST` (预估基因组大小)
- **默认值**: `1g`
- **说明**: 用于设置 Jellyfish 的哈希表大小 (`-s` 参数)。
- **调节建议**:
  - 设置为预估基因组大小即可，支持 `g` (Gb), `m` (Mb), `k` (Kb) 后缀。
  - 如果设置过小，Jellyfish 会自动增加哈希表，但会消耗更多内存和时间；设置过大则浪费内存。

## 4. 污染去除 (Kraken2)

### `KRAKEN_CONFIDENCE` (置信度阈值)
- **默认值**: `0.5`
- **说明**: 判定一条 Read 属于某个分类单元的最低置信度 (0-1)。
- **调节建议**:
  - **0.0 (默认)**: 只要有 K-mer 匹配就分类，敏感度高但假阳性高。
  - **0.1 - 0.3**: 适用于常规宏基因组分析。
  - **0.5 - 0.8**: 适用于基因组组装去污染，我们需要高准确度，避免误删目标物种的序列。推荐 `0.5`。

### `KRAKEN_MIN_HIT_GROUPS` (最小命中组数)
- **默认值**: `300`
- **说明**: 判定分类所需的最小 K-mer 命中数。
- **调节建议**: 针对 HiFi 这种长读长数据，建议设置较高（如 `300`），以确保分类的可靠性。

## 5. 基因组组装 (Hifiasm)

虽然 `config.sh` 中没有直接暴露 Hifiasm 的所有参数，但您可以在 `scripts/run_assembly.sh` 的 `run_assembly` 函数中手动修改：

- **`-l` (Purge Level)**: 清除单倍型重复的级别。
  - `0`: 不清除 (适用于近交系)。
  - `1` (默认): 轻度清除 (适用于杂合个体)。
  - `2`: 强力清除。
  - **建议**: 如果组装出的基因组大小远大于预估值，尝试改为 `-l 2`。
  
- **`--h1` / `--h2`**: 如果有 Hi-C 数据，加入这两个参数可以实现 **Haplotype-resolved Assembly** (分型组装)，即直接组装出两套单倍体基因组。

## 6. Hi-C 挂载 (Chromap & Yahs)

### `CHROMAP_PRESET` (预设模式)
- **默认值**: `hic`
- **说明**: Chromap 的运行模式。
- **调节建议**: 保持 `hic` 即可。

### Yahs 参数 (需在脚本中修改)
- **`-e` (限制性内切酶)**: 
  - 默认自动检测。
  - 如果明确知道建库使用的酶（如 `GATC`），可以在命令中显式指定，可能略微提高准确性。

## 7. 可视化 (Juicer)

### `JUICER_JVM_MEM` (Java 内存)
- **默认值**: `50g`
- **说明**: Juicer Tools 运行时的最大 Java 堆内存。
- **调节建议**:
  - **大型基因组**: 必须设置得很大，否则会报 `OutOfMemoryError`。例如人类基因组可能需要 `100g` 或更多。
  - **小型基因组**: 可适当降低至 `10g` 或 `20g`。
  - **注意**: 请确保服务器物理内存大于此值。

---

## 总结：常见场景参数预设

### 场景 A: 简单小型基因组 (如细菌, 5Mb)
- `THREADS`: 4
- `KMER_SIZE`: 15
- `GENOME_SIZE_EST`: 10m
- `JUICER_JVM_MEM`: 4g

### 场景 B: 复杂大型哺乳动物 (如灵长类, 3Gb)
- `THREADS`: 48
- `KMER_SIZE`: 21
- `GENOME_SIZE_EST`: 3g
- `KRAKEN_CONFIDENCE`: 0.5
- `JUICER_JVM_MEM`: 120g

### 场景 C: 高杂合植物 (如马铃薯)
- `THREADS`: 64
- `KMER_SIZE`: 21
- `Hifiasm 参数`: 建议在脚本中添加 `-l 2` 或使用 Hi-C 模式 (`--h1`, `--h2`)
